<div class="p-6">
  <!-- Campo de Seleção -->
  <div class="mb-6">
    <label class="block text-sm font-medium mb-2 field-label">Conferente</label>

    <!-- Input/Dropdown -->
    <div class="relative">
      <div
        (click)="showUserSelection = !showUserSelection"
        class="overlay-select-field w-full px-4 py-3 rounded-md border cursor-pointer flex items-center justify-between transition-colors">
        <span class="truncate">
          @if (getSelectedUser()) {
            {{ getSelectedUser()?.email }}
          } @else if (currentUser) {
            {{ currentUser.email }}
          } @else {
            Selecione um conferente...
          }
        </span>
        <svg class="w-4 h-4 transition-transform dropdown-icon" [class.rotate-180]="showUserSelection" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>

      <!-- Lista de Usuários -->
      @if (showUserSelection) {
        <div class="absolute z-10 w-full mt-1 rounded-md border shadow-lg max-h-60 overflow-y-auto user-list">

          <!-- Lista de Usuários -->
          @for (user of users; track user.id) {
            <div
              (click)="currentUser?.id !== user.id ? selectUser(user.id) : null"
              class="overlay-user-item px-3 py-2 text-sm transition-colors"
              [ngClass]="{
                'overlay-user-selected': selectedUserId === user.id,
                'overlay-user-current': currentUser?.id === user.id
              }">
              <div class="flex items-center gap-2">
                @if (currentUser?.id === user.id) {
                  <svg class="w-4 h-4 check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                } @else if (selectedUserId === user.id) {
                  <svg class="w-4 h-4 check-icon-selected" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                }
                <div class="flex-1">
                  <div class="font-medium">{{ user.email }}</div>
                  <div class="text-xs secondary-text">
                    @if (currentUser?.id === user.id) {
                      (Atual)
                    } @else {
                      {{ getUserRoleLabel(user.role) }}
                    }
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Botões de Ação -->
  <div class="flex gap-2 mt-4">
    <!-- Botão Remover (só aparece quando há usuário atribuído) -->
    @if (currentUser) {
      <button
        (click)="releaseCavalete()"
        [disabled]="assigning"
        class="overlay-remove-btn flex-1 px-4 py-3 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2">
        @if (assigning) {
          <span class="flex items-center justify-center gap-2">
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            Removendo...
          </span>
        } @else {
          Remover
        }
      </button>
    }

    <!-- Botão Confirmar -->
    <button
      (click)="confirmAssignment()"
      [disabled]="assigning || selectedUserId === null"
      class="overlay-confirm-btn flex-1 px-4 py-3 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2">
      @if (assigning) {
        <span class="flex items-center justify-center gap-2">
          <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          Confirmando...
        </span>
      } @else {
        Confirmar
      }
    </button>
  </div>
</div>
